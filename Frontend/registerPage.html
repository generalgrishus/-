<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Регистрация пользователя</title>
  <link rel="stylesheet" href="register.css">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
  <script src="
    https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js
    "></script>

  <a href = "startpage.html"><img src = "img/tostartPageButton.png" width = 20%></a>
  <p>Придумайте логин</p>
  <input class="usernameText" type = "text" id= "username">
  <p class = "emailText">Введите Email</p>
  <input type = "text" id = "email">
  <p><img class = "image1" src = "img/aboutUs.png"></p>
  <input type = "password" id = "password1">
  <p>Повторите пароль</p>
  <input type = "password" id = "password2">
  <p></p>
  <button type="button" onclick="send()"><img src = "img/add.jpg"></button><br>

  <a href ="authorizationPage.html">Уже регистрировались? Авторизуйтесь</a>

  <p id = "container" style="color: orangered;"></p>
  <p id = "container1" style="color: orangered;"></p>
  <p id = "container2" style="color: orangered;"></p>
  
  <script>
    send = function(){
      const requestUrl = 'http://127.0.0.1:8000/api/reg/';
      //const reqUrl = 'https://jsonplaceholder.typicode.com/posts'
      const userData = {  
        username: "ppppppeee",
        email: "ppppppeee@mail.ru",
        password1: "Uhbif134",
        password2: "Uhbif134"
      // username: username.value,
      // email: email.value,
      // password1: password1.value,
      // password2: password2.value
      // username: "sonyavvvvv",
      // password: ""
    };
    var cookie = Cookies.get('csrftoken');
    const config = {
        method: "POST",
        headers: new Headers({"content-type": "application/json"},{'X-CSRFToken': cookie}),
        credentials: 'include',
        body: JSON.stringify(userData)
    };
    const request = fetch("http://127.0.0.1:8000/api/reg/", config
    )
    .then(response => response.json())
    .then(function (response) {
      const returnData = (response);
      jsonData = JSON.parse(returnData);
      receivedErrors = jsonData.errors;
      if (receivedErrors != null){
        console.log('here is not null');
        const container = document.getElementById('password2');
        const answer = document.createElement('p');
        if (receivedErrors.username){
          answer.innerText = `${receivedErrors.username[0]}`
          container.appendChild(answer);
        }
        if (receivedErrors.email){
          answer.innerText = `${receivedErrors.email[0]}`
          container.appendChild(answer);
        }
        if (receivedErrors.password1){
          answer.innerText = `${receivedErrors.password1[0]}`
          container.appendChild(answer);
        }
        if (receivedErrors.password2){
          answer.innerText = `${receivedErrors.password2[0]}`
          container.appendChild(answer);
        }
        
        //asdsasa@mail.ru
      }
      else{
        console.log("here is null");
        if (jsonData.success == true)
        {
          window.location.href = window.location.href
          const isRequestSuccess = (async () => {
          return await getRequest()
          })();

          if (isRequestSuccess){
              window.location.href = 'index.html';
          }
        }  
      }
      })
    }
  
  </script>

<script>
  async function getRequest(){
    // axios.get("http://127.0.0.1:8000/places/", withCredentials=true)
    // .then(response => response.json())
    // .then(function(data) {
    // console.log(data);
    // });
    var result = await fetch("http://127.0.0.1:8000/places/",
    {
        method: "GET",
        credentials: 'include'
    })
    return result.status == 200;
  }
</script>
</body>
</html>
